<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Summary</title>
    <link rel="stylesheet" href="static/style.css">  <!-- ‚úÖ Ensure correct CSS path -->
</head>
<body>
    <h1>AI News Summary</h1>
    <p>Enter a topic to get the latest AI-generated news summary.</p>
    
    <input type="text" id="topicInput" placeholder="Enter a topic...">
    <button onclick="fetchSummary()">Get Summary</button>

    <div id="result"></div>
    
    <!-- History Section -->
    <h2>Topic History</h2>
    <div id="history">Loading history...</div>  <!-- ‚úÖ Default text -->

    <script>
        async function fetchSummary() {
            console.log("üî• fetchSummary() function triggered!");

            const topic = document.getElementById("topicInput").value.trim();
            const resultDiv = document.getElementById("result");
            const historyDiv = document.getElementById("history"); // ‚úÖ Get history div

            if (!topic) {
                resultDiv.innerHTML = "<p style='color: red;'>‚ö†Ô∏è Please enter a topic!</p>";
                return;
            }

            resultDiv.innerHTML = "<p>‚è≥ Loading...</p>";
            historyDiv.innerHTML = "Fetching history..."; // ‚úÖ Show message while loading

            const BASE_URL = window.location.hostname.includes("localhost") 
                ? "http://127.0.0.1:8000" 
                : "https://azukimedia.up.railway.app";

            try {
                console.log(`üîó Fetching: ${BASE_URL}/summary/${encodeURIComponent(topic)}`);

                const summaryResponse = await fetch(`${BASE_URL}/summary/${encodeURIComponent(topic)}`, {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });

                if (!summaryResponse.ok) {
                    throw new Error(`‚ùå Server error: ${summaryResponse.status} - ${summaryResponse.statusText}`);
                }

                const summaryData = await summaryResponse.json();
                console.log("‚úÖ API Response:", summaryData);

                const tweetContainer = document.createElement("div");
                tweetContainer.classList.add("tweet-container");

                tweetContainer.innerHTML = `
                    <div class="tweet-header">
                        <img class="profile-pic" src="https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png" alt="Profile">
                        <div>
                            <div class="tweet-username">AzukiMedia</div>
                            <div class="tweet-meta">@azukimedia ¬∑ Just Now</div>
                        </div>
                    </div>
                    <div class="tweet-body"></div>
                `;

                // ‚úÖ Use innerText to prevent unwanted HTML rendering issues
                tweetContainer.querySelector(".tweet-body").innerText = summaryData.summary;

                resultDiv.innerHTML = ""; // Clear previous results
                resultDiv.appendChild(tweetContainer);

                // ‚úÖ Force style refresh
                tweetContainer.offsetHeight; // Trigger reflow

                // ‚úÖ Fetch History After New Summary is Generated
                await fetchHistory(topic);

            } catch (error) {
                console.error("üö® Fetch error:", error);
                resultDiv.innerHTML = `<p style='color: red;'>‚ö†Ô∏è Error fetching summary: ${error.message}. Try again!</p>`;
            }
        }

        async function fetchHistory(topic) {
            console.log(`üìú Fetching history for: ${topic}`);

            const historyDiv = document.getElementById("history");
            const BASE_URL = window.location.hostname.includes("localhost") 
                ? "http://127.0.0.1:8000" 
                : "https://azukimedia.up.railway.app";

            try {
                const historyResponse = await fetch(`${BASE_URL}/history/${encodeURIComponent(topic)}`, {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });

                if (!historyResponse.ok) {
                    throw new Error(`‚ùå Server error: ${historyResponse.status} - ${historyResponse.statusText}`);
                }

                const historyData = await historyResponse.json();
                console.log("üìú History Response:", historyData);

                if (!historyData.history.length) {
                    historyDiv.innerHTML = "<p>üìú No past summaries found for this topic.</p>";
                    return;
                }

                historyDiv.innerHTML = historyData.history.map(entry => `
                    <div class="tweet-container">
                        <div class="tweet-header">
                            <img class="profile-pic" src="https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png" alt="Profile">
                            <div>
                                <div class="tweet-username">AzukiMedia</div>
                                <div class="tweet-meta">@azukimedia ¬∑ ${entry.date}</div>
                            </div>
                        </div>
                        <div class="tweet-body">${entry.summary}</div>
                    </div>
                `).join("");

            } catch (error) {
                console.error("üö® History fetch error:", error);
                historyDiv.innerHTML = `<p style='color: red;'>‚ö†Ô∏è Error fetching history: ${error.message}. Try again!</p>`;
            }
        }
    </script>                       
</body>
</html>
