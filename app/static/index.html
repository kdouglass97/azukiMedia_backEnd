<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Summary</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>

    <h1>AI News Summary</h1>
    <p>Enter a topic to get the latest AI-generated news summary.</p>
    
    <input type="text" id="topicInput" placeholder="Enter a topic...">
    <button onclick="fetchSummary()">Get Summary</button>

    <div id="result"></div>
    
    <h2>Topic History</h2>
    <div id="history">Loading history...</div>

    <script>
        // Check if we're running on localhost or 127.0.0.1
        const isLocalEnv = (
            window.location.hostname.includes("localhost") ||
            window.location.hostname.includes("127.0.0.1")
        );

        // Decide which BASE_URL to use
        const BASE_URL = isLocalEnv 
            ? "http://127.0.0.1:8000" 
            : "https://azukimedia.up.railway.app";

        async function fetchSummary() {
            console.log("üî• fetchSummary() function triggered!");

            const topic = document.getElementById("topicInput").value.trim();
            const resultDiv = document.getElementById("result");
            const historyDiv = document.getElementById("history");

            if (!topic) {
                resultDiv.innerHTML = "<p style='color: red;'>‚ö†Ô∏è Please enter a topic!</p>";
                return;
            }

            resultDiv.innerHTML = "<p>‚è≥ Loading...</p>";
            historyDiv.innerHTML = "Fetching history...";

            try {
                console.log(`üîó Fetching summary: ${BASE_URL}/summary/${encodeURIComponent(topic)}`);

                const response = await fetch(`${BASE_URL}/summary/${encodeURIComponent(topic)}`, {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });

                if (!response.ok) {
                    throw new Error(`‚ùå Server error: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();
                console.log("‚úÖ API Response (from DB):", data);

                resultDiv.innerHTML = `
                    <div class="tweet-container">
                        <div class="tweet-header">
                            <img class="profile-pic" src="https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png" alt="Profile">
                            <div>
                                <div class="tweet-username">AzukiMedia</div>
                                <div class="tweet-meta">@azukimedia ¬∑ Just Now</div>
                            </div>
                        </div>
                        <div class="tweet-body">${data.summary}</div>
                    </div>
                `;

                // Fetch past summaries
                fetchHistory(topic);

            } catch (error) {
                console.error("üö® Fetch error:", error);
                resultDiv.innerHTML = `<p style='color: red;'>‚ö†Ô∏è Error fetching summary: ${error.message}. Try again!</p>`;
            }
        }

        async function fetchHistory(topic) {
            console.log(`üìú Fetching history for: ${topic}`);
            const historyDiv = document.getElementById("history");

            try {
                const historyResponse = await fetch(`${BASE_URL}/history/${encodeURIComponent(topic)}`, {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });

                if (!historyResponse.ok) {
                    throw new Error(`‚ùå Server error: ${historyResponse.status} - ${historyResponse.statusText}`);
                }

                const historyData = await historyResponse.json();
                console.log("üìú History Response:", historyData);

                if (!historyData.history?.length) {
                    historyDiv.innerHTML = "<p>üìú No past summaries found for this topic.</p>";
                    return;
                }

                historyDiv.innerHTML = historyData.history.map(entry => `
                    <div class="tweet-container">
                        <div class="tweet-header">
                            <img class="profile-pic" src="https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png" alt="Profile">
                            <div>
                                <div class="tweet-username">AzukiMedia</div>
                                <div class="tweet-meta">@azukimedia ¬∑ ${entry.date}</div>
                            </div>
                        </div>
                        <div class="tweet-body">${entry.summary.replace(/\n/g, "<br>")}</div>
                    </div>
                `).join("");

            } catch (error) {
                console.error("üö® History fetch error:", error);
                historyDiv.innerHTML = `<p style='color: red;'>‚ö†Ô∏è Error fetching history: ${error.message}. Try again!</p>`;
            }
        }
    </script>

</body>
</html>
